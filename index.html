<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokito Star - Panel de Despachos</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #E50695, #ff69b4);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(229, 6, 149, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 2px solid #E50695;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(229, 6, 149, 0.4);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #E50695;
            display: block;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #ccc;
        }

        .search-section {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 2px solid #E50695;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #E50695;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E50695;
            border-radius: 8px;
            background: #000;
            color: white;
            font-size: 1em;
        }

        .form-input::placeholder {
            color: #666;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #E50695, #ff69b4);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 6, 149, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffca2c);
            color: #000;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .orders-section {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 2px solid #E50695;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .orders-table th {
            background: #E50695;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .orders-table tr:hover {
            background: rgba(229, 6, 149, 0.1);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .status-pendiente {
            background: #ffc107;
            color: #000;
        }

        .status-proceso {
            background: #17a2b8;
            color: white;
        }

        .status-enviado {
            background: #28a745;
            color: white;
        }

        .status-entregado {
            background: #6f42c1;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border: 2px solid #E50695;
            border-radius: 15px;
            padding: 30px;
            margin: 5% auto;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E50695;
        }

        .modal-title {
            color: #E50695;
            font-size: 1.5em;
            font-weight: bold;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .order-details {
            background: rgba(229, 6, 149, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #E50695;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #E50695;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #28a745;
            color: white;
        }

        .alert-danger {
            background: #dc3545;
            color: white;
        }

        .alert-warning {
            background: #ffc107;
            color: #000;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: rgba(229, 6, 149, 0.2);
            border: 2px solid #E50695;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .filter-tab.active {
            background: #E50695;
            color: white;
        }

        .filter-tab:hover {
            background: rgba(229, 6, 149, 0.4);
        }

        .actions-column {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .orders-table {
                font-size: 0.9em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .actions-column {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® Panel de Despachos ‚ú®</h1>
            <p>Gesti√≥n de Pedidos Kokito Star</p>
        </div>

        <!-- Dashboard de Estad√≠sticas -->
        <div class="dashboard" id="dashboard">
            <div class="stat-card">
                <span class="stat-number" id="totalPedidos">0</span>
                <span class="stat-label">Total Pedidos</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="pendientes">0</span>
                <span class="stat-label">Pendientes</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="proceso">0</span>
                <span class="stat-label">En Proceso</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="enviados">0</span>
                <span class="stat-label">Enviados</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="entregados">0</span>
                <span class="stat-label">Entregados</span>
            </div>
        </div>

        <!-- Secci√≥n de B√∫squeda -->
        <div class="search-section">
            <h3 style="color: #E50695; margin-bottom: 20px;">üîç Buscar Pedidos</h3>
            <div class="search-form">
                <div class="form-group">
                    <label class="form-label">C√≥digo de Compra</label>
                    <input type="text" class="form-input" id="searchCodigo" placeholder="KIT110625-01">
                </div>
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-input" id="searchCliente" placeholder="Nombre del cliente">
                </div>
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select class="form-input" id="searchEstado">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; align-items: end;">
                    <button class="btn btn-primary" onclick="buscarPedidos()">üîç Buscar</button>
                    <button class="btn btn-secondary" onclick="cargarTodosPedidos()">üìã Ver Todos</button>
                </div>
            </div>
        </div>

        <!-- Filtros R√°pidos -->
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="todos" onclick="filtrarPedidos('todos')">
                Todos
            </div>
            <div class="filter-tab" data-filter="Pendiente" onclick="filtrarPedidos('Pendiente')">
                Pendientes
            </div>
            <div class="filter-tab" data-filter="En Proceso" onclick="filtrarPedidos('En Proceso')">
                En Proceso
            </div>
            <div class="filter-tab" data-filter="Enviado" onclick="filtrarPedidos('Enviado')">
                Enviados
            </div>
            <div class="filter-tab" data-filter="Entregado" onclick="filtrarPedidos('Entregado')">
                Entregados
            </div>
        </div>

        <!-- Lista de Pedidos -->
        <div class="orders-section">
            <h3 style="color: #E50695; margin-bottom: 20px;">üì¶ Lista de Pedidos</h3>
            
            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Cargando pedidos...</p>
            </div>

            <div id="alertsContainer"></div>

            <div style="overflow-x: auto;">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Ciudad</th>
                            <th>Kits</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Transportadora</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Los pedidos se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Ver/Editar Pedido -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detalles del Pedido</h3>
                <button class="close-btn" onclick="cerrarModal()">&times;</button>
            </div>

            <div id="modalAlerts"></div>

            <div class="order-details" id="orderDetailsContainer">
                <!-- Los detalles se cargar√°n aqu√≠ -->
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select class="form-input" id="modalEstado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transportadora</label>
                    <input type="text" class="form-input" id="modalTransportadora" placeholder="Ej: Servientrega, Interrapid√≠simo">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">N√∫mero de Gu√≠a</label>
                    <input type="text" class="form-input" id="modalNumeroGuia" placeholder="N√∫mero de gu√≠a de env√≠o">
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Env√≠o</label>
                    <input type="date" class="form-input" id="modalFechaEnvio">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Valor del Env√≠o</label>
                    <input type="number" class="form-input" id="modalValorEnvio" placeholder="Valor del env√≠o" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-input" id="modalObservaciones" rows="2" placeholder="Notas adicionales sobre el pedido..."></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-success" onclick="actualizarPedido()" id="saveBtn">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        // MODO DE PRUEBA - Descomenta esta l√≠nea para usar datos de ejemplo
        // const MODO_PRUEBA = true;  
        const MODO_PRUEBA = false;  // VOLVER A MODO REAL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwvRrS4oJ56Tpv0lHnSyUbP6-LS_gewgMXXgaDcTjq8yySVowaCQ-wRgeWXT4MGDdLC/exec';

        // Datos de ejemplo para pruebas
        const datosEjemplo = [
            {
                'C√≥digo Compra': 'KIT110625-01',
                'Fecha': '11/6/2025 3:47:32 PM',
                'Nombre': 'Mar√≠a Garc√≠a',
                'Tel√©fono': '3001234567',
                'Direcci√≥n': 'Calle 123 #45-67',
                'Unidad/Edificio': 'Apto 501',
                'Ciudad': 'Medell√≠n',
                'Total Kits': '2',
                'Precio Kits': '290000',
                'Precio Domicilio': '10000',
                'Precio Total': '300000',
                'Detalles Kits': 'KIT 1: Mariposa(5), Unicornio(3) | Colores: üíôAzul oscuro, ü©∑Fucsia || KIT 2: Drag√≥n(4), Flash(2) | Colores: üíõDorado, üíöVerde',
                'Estado': 'Pendiente',
                'Transportadora': '',
                'N√∫mero Gu√≠a': '',
                'Fecha Env√≠o': '',
                'Valor Env√≠o': '',
                'Observaciones': ''
            },
            {
                'C√≥digo Compra': 'KIT110625-02',
                'Fecha': '11/6/2025 4:15:18 PM',
                'Nombre': 'Carlos Ruiz',
                'Tel√©fono': '3109876543',
                'Direcci√≥n': 'Carrera 45 #23-89',
                'Unidad/Edificio': '',
                'Ciudad': 'Bogot√°',
                'Total Kits': '1',
                'Precio Kits': '145000',
                'Precio Domicilio': '10000',
                'Precio Total': '155000',
                'Detalles Kits': 'KIT 1: Batman(8), Gato(4), ‚≠êKuromi(3) | Colores: üñ§Negro, üíúMorado, üíõDorado',
                'Estado': 'En Proceso',
                'Transportadora': 'Servientrega',
                'N√∫mero Gu√≠a': 'SER123456789',
                'Fecha Env√≠o': '2025-06-12',
                'Valor Env√≠o': '8500',
                'Observaciones': 'Cliente solicita entrega en la ma√±ana'
            }
        ];
        
        let pedidosData = [];
        let pedidoActual = null;

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarTodosPedidos();
        });

        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo, contenedor = 'alertsContainer') {
            const container = document.getElementById(contenedor);
            container.innerHTML = `<div class="alert alert-${tipo}">${mensaje}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Funci√≥n para cargar todos los pedidos usando JSONP
        async function cargarTodosPedidos() {
            mostrarCargando(true);
            
            try {
                if (MODO_PRUEBA) {
                    // Usar datos de ejemplo
                    setTimeout(() => {
                        pedidosData = datosEjemplo;
                        mostrarPedidos(pedidosData);
                        actualizarDashboard();
                        mostrarAlerta('‚úÖ Datos de prueba cargados', 'warning');
                        mostrarCargando(false);
                    }, 1000);
                    return;
                }

                // Usar JSONP para evitar problemas de CORS
                const callbackName = 'callback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (data.success) {
                        pedidosData = data.pedidos;
                        mostrarPedidos(pedidosData);
                        actualizarDashboard();
                        mostrarAlerta('‚úÖ Pedidos cargados correctamente', 'success');
                    } else {
                        mostrarAlerta('‚ùå Error al cargar pedidos: ' + data.error, 'danger');
                    }
                    mostrarCargando(false);
                };
                
                script.src = `${GOOGLE_SHEETS_URL}?action=getPedidos&callback=${callbackName}`;
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    mostrarAlerta('‚ùå Error de conexi√≥n. Cambia MODO_PRUEBA = true para usar datos de ejemplo.', 'danger');
                    mostrarCargando(false);
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('Error completo:', error);
                mostrarAlerta('‚ùå Error inesperado al cargar pedidos', 'danger');
                mostrarCargando(false);
            }
        }

        // Funci√≥n para buscar pedidos
        async function buscarPedidos() {
            const codigo = document.getElementById('searchCodigo').value.trim();
            const cliente = document.getElementById('searchCliente').value.trim().toLowerCase();
            const estado = document.getElementById('searchEstado').value;

            if (!codigo && !cliente && !estado) {
                cargarTodosPedidos();
                return;
            }

            mostrarCargando(true);

            try {
                if (MODO_PRUEBA) {
                    // B√∫squeda local en modo de prueba
                    setTimeout(() => {
                        let resultados = pedidosData.filter(pedido => {
                            let coincide = true;
                            
                            if (codigo && !pedido['C√≥digo Compra'].includes(codigo)) {
                                coincide = false;
                            }
                            
                            if (cliente && !pedido.Nombre.toLowerCase().includes(cliente)) {
                                coincide = false;
                            }
                            
                            if (estado && pedido.Estado !== estado) {
                                coincide = false;
                            }
                            
                            return coincide;
                        });
                        
                        mostrarPedidos(resultados);
                        mostrarAlerta(`‚úÖ ${resultados.length} pedido(s) encontrado(s) (modo de prueba)`, 'warning');
                        mostrarCargando(false);
                    }, 500);
                    return;
                }

                if (codigo) {
                    // B√∫squeda espec√≠fica por c√≥digo
                    const response = await fetch(`${GOOGLE_SHEETS_URL}?action=searchByCodigo&codigo=${encodeURIComponent(codigo)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarPedidos([data.pedido]);
                        mostrarAlerta('‚úÖ Pedido encontrado', 'success');
                    } else {
                        mostrarPedidos([]);
                        mostrarAlerta('‚ö†Ô∏è No se encontr√≥ el pedido con ese c√≥digo', 'warning');
                    }
                } else {
                    // Filtrar en datos locales
                    let resultados = pedidosData.filter(pedido => {
                        let coincide = true;
                        
                        if (cliente && !pedido.Nombre.toLowerCase().includes(cliente)) {
                            coincide = false;
                        }
                        
                        if (estado && pedido.Estado !== estado) {
                            coincide = false;
                        }
                        
                        return coincide;
                    });
                    
                    mostrarPedidos(resultados);
                    mostrarAlerta(`‚úÖ ${resultados.length} pedido(s) encontrado(s)`, 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error al buscar pedidos', 'danger');
            }

            mostrarCargando(false);
        }

        // Funci√≥n para filtrar pedidos por estado
        function filtrarPedidos(estado) {
            // Actualizar tabs activos
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${estado}"]`).classList.add('active');

            let pedidosFiltrados;
            if (estado === 'todos') {
                pedidosFiltrados = pedidosData;
            } else {
                pedidosFiltrados = pedidosData.filter(pedido => pedido.Estado === estado);
            }

            mostrarPedidos(pedidosFiltrados);
        }

        // Funci√≥n para mostrar pedidos en la tabla
        function mostrarPedidos(pedidos) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (pedidos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                            üì≠ No se encontraron pedidos
                        </td>
                    </tr>
                `;
                return;
            }

            // Debug: mostrar formato de fecha del primer pedido
            if (pedidos.length > 0) {
                console.log('Formato de fecha recibido:', typeof pedidos[0].Fecha, pedidos[0].Fecha);
            }

            tbody.innerHTML = pedidos.map(pedido => `
                <tr>
                    <td><strong>${pedido['C√≥digo Compra'] || 'N/A'}</strong></td>
                    <td>${formatearFecha(pedido.Fecha)}</td>
                    <td>${pedido.Nombre}</td>
                    <td>${pedido.Ciudad}</td>
                    <td>${pedido['Total Kits']}</td>
                    <td>${formatearNumero(pedido['Precio Total'])}</td>
                    <td><span class="status-badge status-${getStatusClass(pedido.Estado)}">${pedido.Estado || 'Pendiente'}</span></td>
                    <td>${pedido.Transportadora || '-'}</td>
                    <td class="actions-column">
                        <button class="btn btn-primary btn-small" onclick="verPedido('${pedido['C√≥digo Compra']}')">
                            üëÅÔ∏è Ver
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="editarPedido('${pedido['C√≥digo Compra']}')">
                            ‚úèÔ∏è Editar
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Funci√≥n para ver pedido en modal
        async function verPedido(codigo) {
            await cargarPedidoEnModal(codigo, true);
        }

        // Funci√≥n para editar pedido en modal
        async function editarPedido(codigo) {
            await cargarPedidoEnModal(codigo, false);
        }

        // Funci√≥n para cargar pedido en modal usando JSONP
        async function cargarPedidoEnModal(codigo, soloLectura = false) {
            try {
                if (MODO_PRUEBA) {
                    // Buscar en datos de ejemplo
                    const pedido = pedidosData.find(p => p['C√≥digo Compra'] === codigo);
                    if (pedido) {
                        pedidoActual = pedido;
                        mostrarModalPedido(pedidoActual, soloLectura);
                    } else {
                        mostrarAlerta('‚ùå Pedido no encontrado en datos de prueba', 'danger');
                    }
                    return;
                }

                // Usar JSONP para buscar por c√≥digo
                const callbackName = 'search_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (data.success) {
                        pedidoActual = data.pedido;
                        mostrarModalPedido(pedidoActual, soloLectura);
                    } else {
                        mostrarAlerta('‚ùå Error al cargar el pedido: ' + data.error, 'danger');
                    }
                };
                
                script.src = `${GOOGLE_SHEETS_URL}?action=searchByCodigo&codigo=${encodeURIComponent(codigo)}&callback=${callbackName}`;
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    mostrarAlerta('‚ùå Error de conexi√≥n al buscar pedido', 'danger');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('‚ùå Error inesperado', 'danger');
            }
        }

        // Funci√≥n para mostrar modal con datos del pedido
        function mostrarModalPedido(pedido, soloLectura = false) {
            document.getElementById('modalTitle').textContent = `${soloLectura ? 'Ver' : 'Editar'} Pedido - ${pedido['C√≥digo Compra']}`;
            
            // Limpiar alertas del modal
            document.getElementById('modalAlerts').innerHTML = '';
            
            // Mostrar detalles del pedido
            document.getElementById('orderDetailsContainer').innerHTML = `
                <h4 style="color: #E50695; margin-bottom: 15px;">üìã Informaci√≥n del Cliente</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div><strong>Nombre:</strong> ${pedido.Nombre}</div>
                    <div><strong>Tel√©fono:</strong> ${pedido.Tel√©fono}</div>
                    <div><strong>Ciudad:</strong> ${pedido.Ciudad}</div>
                    <div><strong>Direcci√≥n:</strong> ${pedido.Direcci√≥n}</div>
                    ${pedido['Unidad/Edificio'] ? `<div><strong>Unidad:</strong> ${pedido['Unidad/Edificio']}</div>` : ''}
                </div>
                
                <h4 style="color: #E50695; margin-bottom: 15px;">üé® Detalles del Pedido</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div><strong>Kits:</strong> ${pedido['Total Kits']}</div>
                    <div><strong>Precio Kits:</strong> ${formatearNumero(pedido['Precio Kits'])}</div>
                    <div><strong>Domicilio:</strong> ${formatearNumero(pedido['Precio Domicilio'])}</div>
                    <div><strong>Total:</strong> ${formatearNumero(pedido['Precio Total'])}</div>
                    ${pedido['Valor Env√≠o'] ? `<div><strong>Costo Real Env√≠o:</strong> ${formatearNumero(pedido['Valor Env√≠o'])}</div>` : ''}
                </div>
                
                ${pedido['Detalles Kits'] ? `
                <h4 style="color: #E50695; margin-bottom: 15px;">üéØ Personalizaci√≥n</h4>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; white-space: pre-wrap; word-wrap: break-word;">
                    ${pedido['Detalles Kits']}
                </div>
                ` : ''}
            `;

            // Llenar campos del formulario
            document.getElementById('modalEstado').value = pedido.Estado || 'Pendiente';
            document.getElementById('modalTransportadora').value = pedido.Transportadora || '';
            document.getElementById('modalNumeroGuia').value = pedido['N√∫mero Gu√≠a'] || '';
            document.getElementById('modalValorEnvio').value = pedido['Valor Env√≠o'] || '';
            document.getElementById('modalObservaciones').value = pedido.Observaciones || '';

            // **PROBLEMA 2 SOLUCIONADO: Fecha autom√°tica del d√≠a actual**
            const fechaActual = new Date().toISOString().split('T')[0];
            document.getElementById('modalFechaEnvio').value = pedido['Fecha Env√≠o'] || fechaActual;

            // Configurar modo de solo lectura
            const campos = ['modalEstado', 'modalTransportadora', 'modalNumeroGuia', 'modalFechaEnvio', 'modalValorEnvio', 'modalObservaciones'];
            campos.forEach(campo => {
                document.getElementById(campo).disabled = soloLectura;
            });

            document.getElementById('saveBtn').style.display = soloLectura ? 'none' : 'block';

            // Mostrar modal
            document.getElementById('orderModal').style.display = 'block';
        }

        // Funci√≥n para actualizar pedido
        async function actualizarPedido() {
            if (!pedidoActual) return;

            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Guardando...';

            try {
                const updates = {
                    'Estado': document.getElementById('modalEstado').value,
                    'Transportadora': document.getElementById('modalTransportadora').value,
                    'N√∫mero Gu√≠a': document.getElementById('modalNumeroGuia').value,
                    'Fecha Env√≠o': document.getElementById('modalFechaEnvio').value,
                    'Valor Env√≠o': document.getElementById('modalValorEnvio').value,
                    'Observaciones': document.getElementById('modalObservaciones').value
                };

                if (MODO_PRUEBA) {
                    // Simular actualizaci√≥n en modo de prueba
                    setTimeout(() => {
                        // Actualizar datos locales
                        const index = pedidosData.findIndex(p => p['C√≥digo Compra'] === pedidoActual['C√≥digo Compra']);
                        if (index !== -1) {
                            Object.assign(pedidosData[index], updates);
                        }
                        
                        mostrarAlerta('‚úÖ Pedido actualizado (modo de prueba)', 'success', 'modalAlerts');
                        mostrarPedidos(pedidosData);
                        actualizarDashboard();
                        
                        setTimeout(() => {
                            cerrarModal();
                        }, 2000);
                        
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                    }, 1000);
                    return;
                }

                console.log('Enviando actualizaci√≥n:', {
                    action: 'updatePedido',
                    codigo: pedidoActual['C√≥digo Compra'],
                    updates: updates
                });

                // **PROBLEMA 1 SOLUCIONADO: Mejorar la llamada al servidor**
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updatePedido',
                        codigo: pedidoActual['C√≥digo Compra'],
                        updates: updates
                    })
                });

                console.log('Respuesta del servidor:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Datos de respuesta:', data);

                if (data.success) {
                    mostrarAlerta('‚úÖ Pedido actualizado correctamente', 'success', 'modalAlerts');
                    
                    // Actualizar datos locales
                    const index = pedidosData.findIndex(p => p['C√≥digo Compra'] === pedidoActual['C√≥digo Compra']);
                    if (index !== -1) {
                        Object.assign(pedidosData[index], updates);
                    }
                    
                    // Actualizar tabla
                    mostrarPedidos(pedidosData);
                    actualizarDashboard();
                    
                    // Cerrar modal despu√©s de 2 segundos
                    setTimeout(() => {
                        cerrarModal();
                    }, 2000);
                    
                } else {
                    mostrarAlerta('‚ùå Error al actualizar: ' + (data.error || 'Error desconocido'), 'danger', 'modalAlerts');
                }

            } catch (error) {
                console.error('Error completo:', error);
                let errorMsg = 'Error de conexi√≥n al actualizar';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Error de red. Verifica tu conexi√≥n a internet.';
                } else if (error.message.includes('HTTP')) {
                    errorMsg = `Error del servidor: ${error.message}`;
                }
                
                mostrarAlerta(`‚ùå ${errorMsg}`, 'danger', 'modalAlerts');
            }

            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }

        // Funci√≥n para cerrar modal
        function cerrarModal() {
            document.getElementById('orderModal').style.display = 'none';
            pedidoActual = null;
        }

        // Funci√≥n para mostrar/ocultar indicador de carga
        function mostrarCargando(mostrar) {
            document.getElementById('loadingIndicator').style.display = mostrar ? 'block' : 'none';
        }

        // Funci√≥n para actualizar dashboard
        function actualizarDashboard() {
            const total = pedidosData.length;
            const pendientes = pedidosData.filter(p => !p.Estado || p.Estado === 'Pendiente').length;
            const proceso = pedidosData.filter(p => p.Estado === 'En Proceso').length;
            const enviados = pedidosData.filter(p => p.Estado === 'Enviado').length;
            const entregados = pedidosData.filter(p => p.Estado === 'Entregado').length;

            document.getElementById('totalPedidos').textContent = total;
            document.getElementById('pendientes').textContent = pendientes;
            document.getElementById('proceso').textContent = proceso;
            document.getElementById('enviados').textContent = enviados;
            document.getElementById('entregados').textContent = entregados;
        }

        // Funciones auxiliares
        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            
            try {
                // Si la fecha ya est√° en formato legible, devolverla tal como est√°
                if (typeof fecha === 'string') {
                    // Verificar si ya est√° en formato DD/MM/YYYY o similar
                    if (fecha.includes('/') || fecha.includes('-')) {
                        // Si contiene barra o gui√≥n, probablemente ya est√° formateada
                        if (fecha.length > 12) {
                            // Si es muy larga, probablemente incluye hora, extraer solo fecha
                            const soloFecha = fecha.split(' ')[0];
                            return soloFecha;
                        }
                        return fecha;
                    }
                    
                    // Intentar parsear como fecha ISO o timestamp
                    const fechaObj = new Date(fecha);
                    if (!isNaN(fechaObj.getTime())) {
                        return fechaObj.toLocaleDateString('es-CO', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                }
                
                // Si es un n√∫mero (timestamp)
                if (typeof fecha === 'number') {
                    const fechaObj = new Date(fecha);
                    return fechaObj.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                // Si es un objeto Date
                if (fecha instanceof Date) {
                    return fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                // Si nada funciona, devolver la fecha tal como est√°
                return fecha.toString();
                
            } catch (error) {
                console.log('Error formateando fecha:', error, 'Fecha original:', fecha);
                // Si hay cualquier error, devolver la fecha original
                return fecha.toString();
            }
        }

        function formatearNumero(numero) {
            if (!numero) return '0';
            
            try {
                // Si ya es un n√∫mero
                if (typeof numero === 'number') {
                    return numero.toLocaleString('es-CO');
                }
                
                // Si es string, limpiar y convertir
                if (typeof numero === 'string') {
                    // Remover caracteres no num√©ricos excepto punto y coma
                    const numeroLimpio = numero.replace(/[^\d.,]/g, '');
                    
                    // Si est√° vac√≠o despu√©s de limpiar
                    if (!numeroLimpio) return '0';
                    
                    // Convertir a n√∫mero
                    const numeroConvertido = parseFloat(numeroLimpio.replace(',', '.'));
                    
                    if (isNaN(numeroConvertido)) return '0';
                    
                    return numeroConvertido.toLocaleString('es-CO');
                }
                
                return '0';
            } catch (error) {
                console.log('Error formateando n√∫mero:', error, 'N√∫mero original:', numero);
                return numero.toString();
            }
        }

        function getStatusClass(estado) {
            switch (estado) {
                case 'Pendiente': return 'pendiente';
                case 'En Proceso': return 'proceso';
                case 'Enviado': return 'enviado';
                case 'Entregado': return 'entregado';
                default: return 'pendiente';
            }
        }

        // Event listeners
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarModal();
            }
        });

        // Cerrar modal al hacer click fuera
        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        // B√∫squeda en tiempo real
        document.getElementById('searchCodigo').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarPedidos();
            }
        });

        document.getElementById('searchCliente').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarPedidos();
            }
        });

        // Auto-refresh cada 5 minutos
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                cargarTodosPedidos();
            }
        }, 300000); // 5 minutos

        // Funci√≥n de exportaci√≥n a CSV (bonus)
        function exportarCSV() {
            if (pedidosData.length === 0) {
                mostrarAlerta('‚ö†Ô∏è No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['C√≥digo Compra', 'Fecha', 'Nombre', 'Tel√©fono', 'Direcci√≥n', 'Ciudad', 'Total Kits', 'Precio Total', 'Estado', 'Transportadora', 'N√∫mero Gu√≠a'];
            const csvContent = [
                headers.join(','),
                ...pedidosData.map(pedido => [
                    pedido['C√≥digo Compra'] || '',
                    pedido.Fecha || '',
                    pedido.Nombre || '',
                    pedido.Tel√©fono || '',
                    pedido.Direcci√≥n || '',
                    pedido.Ciudad || '',
                    pedido['Total Kits'] || '',
                    pedido['Precio Total'] || '',
                    pedido.Estado || '',
                    pedido.Transportadora || '',
                    pedido['N√∫mero Gu√≠a'] || ''
                ].map(field => `"${field}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pedidos_kokito_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarAlerta('‚úÖ Archivo CSV descargado', 'success');
        }

        // Agregar bot√≥n de exportaci√≥n despu√©s del dashboard
        document.addEventListener('DOMContentLoaded', function() {
            const searchSection = document.querySelector('.search-section');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-warning';
            exportBtn.style.marginTop = '15px';
            exportBtn.innerHTML = 'üìä Exportar CSV';
            exportBtn.onclick = exportarCSV;
            searchSection.appendChild(exportBtn);
        });
    </script>
</body>
</html>
