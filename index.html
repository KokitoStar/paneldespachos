<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Despachos Kokito</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            padding: 15px;
        }
        
        .header {
            background: #000000;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #e6007e;
            box-shadow: 0 4px 15px rgba(230, 0, 126, 0.3);
        }
        
        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #e6007e;
        }
        
        .estadisticas-panel {
            background: linear-gradient(135deg, #e6007e 0%, #ff4081 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 4px 15px rgba(230, 0, 126, 0.4);
        }
        
        .estadisticas {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            margin: 5px;
        }
        
        .stat-number {
            font-size: 22px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .stat-label {
            font-size: 13px;
            color: #ffffff;
            font-weight: 500;
        }
        
        .controles {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background-color: #e6007e;
            color: white;
        }
        
        .btn-secondary {
            background-color: #333;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #2a2a2a;
            color: white;
            font-size: 14px;
        }
        
        .search-input:focus {
            border-color: #e6007e;
            outline: none;
        }
        
        .btn-buscar {
            background-color: #e6007e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn-buscar:hover {
            background-color: #c0056a;
        }
        
        .tabs {
            display: flex;
            background: #1a1a1a;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: visible;
            padding: 8px 0;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            background: #2a2a2a;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid #444;
            margin: 0 5px;
            border-radius: 6px;
        }
        
        .tab.active {
            background: #e6007e;
            border-color: #e6007e;
        }
        
        .tab-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4444;
            color: white;
            font-size: 10px;
            padding: 3px 7px;
            border-radius: 12px;
            min-width: 18px;
            text-align: center;
            border: 2px solid #000;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }
        
        .pedidos-container {
            margin-bottom: 20px;
        }
        
        .pedidos-lista {
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .pedido-fila {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px 80px;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .pedido-fila:hover {
            background: #252525;
            border-left: 4px solid #e6007e;
            padding-left: 16px;
        }
        
        .pedido-fila:last-child {
            border-bottom: none;
        }
        
        .pedido-codigo {
            font-size: 14px;
            font-weight: bold;
            color: #e6007e;
        }
        
        .pedido-nombre {
            font-size: 13px;
            color: #ffffff;
        }
        
        .pedido-ciudad {
            font-size: 12px;
            color: #cccccc;
        }
        
        .pedido-telefono {
            font-size: 12px;
            color: #999999;
            font-family: monospace;
        }
        
        .pedido-estado {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        .pedido-acciones {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .btn-accion {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-ver {
            background-color: #007bff;
            color: white;
        }
        
        .btn-editar {
            background-color: #ffc107;
            color: black;
        }
        
        .btn-accion:hover {
            transform: translateY(-1px);
        }
        
        .pedidos-headers {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 120px 80px;
            gap: 15px;
            padding: 12px 20px;
            background: #333;
            color: #ccc;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 2px solid #e6007e;
            border-radius: 8px 8px 0 0;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .pedido-fila, .pedidos-headers {
                grid-template-columns: 1fr 1fr 1fr 100px 60px;
                gap: 10px;
            }
            
            .pedido-telefono {
                display: none;
            }
            
            .pedidos-headers .header-telefono {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .pedido-fila, .pedidos-headers {
                grid-template-columns: 1fr 1fr 80px 50px;
                gap: 8px;
            }
            
            .pedido-ciudad, .header-ciudad {
                display: none;
            }
            
            .pedido-fila {
                padding: 12px 15px;
            }
            
            .pedidos-headers {
                padding: 10px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .pedido-fila, .pedidos-headers {
                grid-template-columns: 1fr 80px 40px;
                gap: 5px;
            }
            
            .pedido-nombre, .header-nombre {
                display: none;
            }
            
            .pedido-fila {
                padding: 10px 12px;
            }
            
            .pedidos-headers {
                padding: 8px 12px;
            }
            
            .btn-accion {
                padding: 4px 6px;
                font-size: 9px;
            }
        }
        
        .estado-pendiente { background: #dc3545; color: white; }
        .estado-proceso { background: #ffc107; color: black; }
        .estado-enviado { background: #007bff; color: white; }
        .estado-entregado { background: #28a745; color: white; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-pedidos {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: #1a1a1a;
            color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #2a2a2a;
            color: white;
            font-size: 12px;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: #e6007e;
            outline: none;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: white;
        }
        
        .detalle-pedido p {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transform: translateX(350px);
            transition: all 0.4s ease;
            min-width: 300px;
            text-align: center;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-left: 4px solid #155724;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
            border-left: 4px solid #721c24;
        }
        
        .notification .close-notification {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .notification .close-notification:hover {
            opacity: 1;
        }
        
        .exportar-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚚 Despachos Kokito</h1>
        </div>
        
        <div class="estadisticas-panel">
            <div class="stat-item">
                <div class="stat-number" id="statPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statEnviados">0</div>
                <div class="stat-label">Enviados</div>
            </div>
        </div>
        
        <div class="controles">
            <div class="search-filters">
                <input type="text" id="searchCodigo" class="search-input" placeholder="🔍 Buscar por código de pedido">
                <button class="btn-buscar" onclick="buscarPedido()">🔍 BUSCAR</button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="cargarDatos()">🔄 Actualizar</button>
                <button class="btn btn-secondary" onclick="mostrarHistorico()">📋 Histórico</button>
                <button class="btn btn-info" onclick="exportarExcel()">📊 Exportar Excel</button>
            </div>
            <div class="exportar-section">
                <input type="date" id="fechaInicio" class="search-input" style="width: 120px;">
                <input type="date" id="fechaFin" class="search-input" style="width: 120px;">
                <button class="btn btn-success" onclick="exportarRango()">📅 Exportar Rango</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('pendientes')" id="tabPendientes">
                Pendientes <span class="tab-badge" id="badgePendientes">0</span>
            </button>
            <button class="tab" onclick="cambiarTab('enviados')" id="tabEnviados">
                Enviados <span class="tab-badge" id="badgeEnviados">0</span>
            </button>
            <button class="tab" onclick="cambiarTab('entregados')" id="tabEntregados">
                Entregados <span class="tab-badge" id="badgeEntregados">0</span>
            </button>
        </div>
        
        <div id="contenido" class="loading">
            Cargando pedidos...
        </div>
    </div>

    <div class="auto-update" id="autoUpdate" style="position: fixed; bottom: 20px; right: 20px; background: #e6007e; color: white; padding: 8px 12px; border-radius: 20px; font-size: 10px; z-index: 100;">
        ⏱️ Próxima actualización: <span id="countdown">5:00</span>
    </div>

    <!-- Modal Ver Pedido -->
    <div id="modalVer" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalVer')">&times;</span>
            <h3>📦 Detalles del Pedido</h3>
            <div id="detallesPedido" class="detalle-pedido"></div>
        </div>
    </div>

    <!-- Modal Editar Estado -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalEditar')">&times;</span>
            <h3>✏️ Editar Estado</h3>
            <form id="formEditar">
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="estadoPedido">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transportadora:</label>
                    <select id="transportadora">
                        <option value="">Seleccionar...</option>
                        <option value="Coordinadora">Coordinadora</option>
                        <option value="Servientrega">Servientrega</option>
                        <option value="Inter Rapidísimo">Inter Rapidísimo</option>
                        <option value="Uber">Uber (Local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Número de Guía:</label>
                    <input type="text" id="numeroGuia" placeholder="Número de guía">
                </div>
                <div class="form-group">
                    <label>Valor Domicilio:</label>
                    <input type="number" id="valorDomicilioReal" placeholder="Valor real">
                </div>
                <div class="form-group">
                    <label>Fecha Entrega:</label>
                    <input type="date" id="fechaEntrega">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="guardarCambios()">💾 Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalEditar')">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Histórico -->
    <div id="modalHistorico" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalHistorico')">&times;</span>
            <h3>📋 Histórico Completo</h3>
            <div id="listaHistorico"></div>
        </div>
    </div>

    <script>
        let todosLosPedidos = [];
        let pedidosFiltrados = [];
        let tabActual = 'pendientes';
        let pedidoActual = null;
        let autoUpdateInterval;
        let countdownInterval;
        let tiempoRestante = 300; // 5 minutos en segundos

        function iniciarAutoUpdate() {
            // Actualizar cada 5 minutos
            autoUpdateInterval = setInterval(() => {
                cargarDatos();
                tiempoRestante = 300;
            }, 300000);

            // Countdown cada segundo
            countdownInterval = setInterval(() => {
                tiempoRestante--;
                const minutos = Math.floor(tiempoRestante / 60);
                const segundos = tiempoRestante % 60;
                document.getElementById('countdown').textContent = 
                    `${minutos}:${segundos.toString().padStart(2, '0')}`;
                
                if (tiempoRestante <= 0) {
                    tiempoRestante = 300;
                }
            }, 1000);
        }

        function cargarDatos() {
            document.getElementById('contenido').innerHTML = '<div class="loading">Cargando...</div>';
            google.script.run
                .withSuccessHandler(function(resultado) {
                    todosLosPedidos = resultado.pedidos;
                    actualizarEstadisticas(resultado.estadisticas);
                    pedidosFiltrados = todosLosPedidos; // Inicializar filtrados
                    mostrarPedidosPorTab();
                })
                .withFailureHandler(mostrarError)
                .obtenerTodosLosDatos();
        }

        function buscarPedido() {
            const searchCodigo = document.getElementById('searchCodigo').value.toLowerCase().trim();
            
            if (searchCodigo === '') {
                // Si no hay búsqueda, mostrar todos
                pedidosFiltrados = todosLosPedidos;
            } else {
                // Filtrar por código
                pedidosFiltrados = todosLosPedidos.filter(pedido => {
                    return pedido.codigo.toLowerCase().includes(searchCodigo);
                });
            }

            mostrarPedidosPorTab();
        }

        function actualizarEstadisticas(stats) {
            document.getElementById('statPendientes').textContent = stats.pendientes;
            document.getElementById('statEnviados').textContent = stats.enviados;
        }
        
        function mostrarNotificacion(mensaje, tipo = 'success') {
            // Remover notificación existente si la hay
            const existente = document.querySelector('.notification');
            if (existente) {
                existente.remove();
            }
            
            // Crear nueva notificación
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.innerHTML = `
                <button class="close-notification" onclick="cerrarNotificacion(this)">&times;</button>
                <div>${mensaje}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Mostrar con animación
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-ocultar después de 3 segundos
            setTimeout(() => {
                cerrarNotificacion(notification);
            }, 3000);
        }
        
        function cerrarNotificacion(elemento) {
            const notification = elemento.classList ? elemento : elemento.parentElement;
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 400);
        }

        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            mostrarPedidosPorTab();
        }

        function mostrarPedidosPorTab() {
            let pedidosFiltradosTab = pedidosFiltrados.filter(pedido => {
                switch(tabActual) {
                    case 'pendientes': return pedido.estadoPedido === 'Pendiente' || pedido.estadoPedido === 'En proceso';
                    case 'enviados': return pedido.estadoPedido === 'Enviado';
                    case 'entregados': return pedido.estadoPedido === 'Entregado';
                    default: return true;
                }
            });

            // Actualizar badges
            document.getElementById('badgePendientes').textContent = 
                pedidosFiltrados.filter(p => p.estadoPedido === 'Pendiente' || p.estadoPedido === 'En proceso').length;
            document.getElementById('badgeEnviados').textContent = 
                pedidosFiltrados.filter(p => p.estadoPedido === 'Enviado').length;
            document.getElementById('badgeEntregados').textContent = 
                pedidosFiltrados.filter(p => p.estadoPedido === 'Entregado').length;

            mostrarPedidos(pedidosFiltradosTab);
        }

        function mostrarPedidos(pedidos) {
            if (!pedidos || pedidos.length === 0) {
                document.getElementById('contenido').innerHTML = 
                    '<div class="no-pedidos">No hay pedidos para mostrar</div>';
                return;
            }

            // Ordenar por fecha (más recientes primero)
            pedidos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            let html = '<div class="pedidos-container">';
            html += '<div class="pedidos-lista">';
            
            // Headers
            html += `
                <div class="pedidos-headers">
                    <div>Código</div>
                    <div class="header-nombre">Cliente</div>
                    <div class="header-ciudad">Ciudad</div>
                    <div class="header-telefono">Teléfono</div>
                    <div>Estado</div>
                    <div>Acciones</div>
                </div>
            `;

            // Filas de pedidos
            pedidos.forEach(pedido => {
                const estadoClass = getEstadoClass(pedido.estadoPedido);
                html += `
                    <div class="pedido-fila" onclick="verPedido('${pedido.codigo}')">
                        <div class="pedido-codigo">${pedido.codigo}</div>
                        <div class="pedido-nombre">${pedido.nombre}</div>
                        <div class="pedido-ciudad">${pedido.ciudad}</div>
                        <div class="pedido-telefono">${pedido.telefono}</div>
                        <div class="pedido-estado ${estadoClass}">${pedido.estadoPedido}</div>
                        <div class="pedido-acciones" onclick="event.stopPropagation()">
                            <button class="btn-accion btn-ver" onclick="verPedido('${pedido.codigo}')" title="Ver detalles">👁️</button>
                            <button class="btn-accion btn-editar" onclick="editarEstado('${pedido.codigo}')" title="Editar">✏️</button>
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            document.getElementById('contenido').innerHTML = html;
        }

        function getEstadoClass(estado) {
            switch(estado) {
                case 'Pendiente': return 'estado-pendiente';
                case 'En proceso': return 'estado-proceso';
                case 'Enviado': return 'estado-enviado';
                case 'Entregado': return 'estado-entregado';
                default: return 'estado-pendiente';
            }
        }

        function verPedido(codigo) {
            google.script.run
                .withSuccessHandler(mostrarDetallesPedido)
                .withFailureHandler(mostrarError)
                .obtenerPedidoPorCodigo(codigo);
        }

        function mostrarDetallesPedido(pedido) {
            if (!pedido) {
                mostrarNotificacion('❌ No se encontró el pedido', 'error');
                return;
            }

            const html = `
                <p><strong>Código:</strong> ${pedido.codigo}</p>
                <p><strong>Fecha:</strong> ${pedido.fecha}</p>
                <p><strong>Nombre:</strong> ${pedido.nombre}</p>
                <p><strong>Teléfono:</strong> ${pedido.telefono}</p>
                <p><strong>Dirección:</strong> ${pedido.direccion}</p>
                <p><strong>Ciudad:</strong> ${pedido.ciudad}</p>
                <p><strong>Total Kits:</strong> ${pedido.totalKits}</p>
                <p><strong>Precio Total:</strong> $${pedido.precioTotal}</p>
                <p><strong>Detalles:</strong> ${pedido.detallesKits}</p>
                <p><strong>Estado:</strong> <span class="estado-mini ${getEstadoClass(pedido.estadoPedido)}">${pedido.estadoPedido}</span></p>
                <p><strong>Transportadora:</strong> ${pedido.transportadora}</p>
                <p><strong>Guía:</strong> ${pedido.numeroGuia}</p>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-warning" onclick="editarEstado('${pedido.codigo}')">✏️ Editar</button>
                </div>
            `;
            
            document.getElementById('detallesPedido').innerHTML = html;
            document.getElementById('modalVer').style.display = 'block';
        }

        function editarEstado(codigo) {
            cerrarModal('modalVer');
            google.script.run
                .withSuccessHandler(function(pedido) {
                    if (!pedido) {
                        mostrarNotificacion('❌ No se encontró el pedido', 'error');
                        return;
                    }
                    
                    pedidoActual = pedido;
                    
                    document.getElementById('estadoPedido').value = pedido.estadoPedido || 'Pendiente';
                    document.getElementById('transportadora').value = pedido.transportadora || '';
                    document.getElementById('numeroGuia').value = pedido.numeroGuia || '';
                    document.getElementById('valorDomicilioReal').value = pedido.valorDomicilioReal || '';
                    
                    const hoy = new Date().toISOString().split('T')[0];
                    document.getElementById('fechaEntrega').value = pedido.fechaEntrega || hoy;
                    
                    document.getElementById('modalEditar').style.display = 'block';
                })
                .withFailureHandler(mostrarError)
                .obtenerPedidoPorCodigo(codigo);
        }

        function guardarCambios() {
            if (!pedidoActual) return;

            const datos = {
                estadoPedido: document.getElementById('estadoPedido').value,
                transportadora: document.getElementById('transportadora').value,
                numeroGuia: document.getElementById('numeroGuia').value,
                valorDomicilioReal: document.getElementById('valorDomicilioReal').value,
                fechaEntrega: document.getElementById('fechaEntrega').value
            };

            google.script.run
                .withSuccessHandler(function(resultado) {
                    if (resultado) {
                        mostrarNotificacion('✅ Cambios guardados correctamente', 'success');
                        cerrarModal('modalEditar');
                        cargarDatos();
                    } else {
                        mostrarNotificacion('❌ Error al guardar los cambios', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarNotificacion('❌ Error: ' + error, 'error');
                })
                .actualizarPedido(pedidoActual.codigo, datos);
        }

        function mostrarHistorico() {
            google.script.run
                .withSuccessHandler(function(pedidos) {
                    let html = '<div class="pedidos-grid">';
                    if (!pedidos || pedidos.length === 0) {
                        html = '<div class="no-pedidos">No hay histórico</div>';
                    } else {
                        pedidos.forEach(pedido => {
                            html += `
                                <div class="pedido-mini" onclick="verPedido('${pedido.codigo}')">
                                    <div class="codigo-mini">${pedido.codigo}</div>
                                    <div class="ciudad-mini">📍 ${pedido.ciudad}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    document.getElementById('listaHistorico').innerHTML = html;
                    document.getElementById('modalHistorico').style.display = 'block';
                })
                .withFailureHandler(mostrarError)
                .obtenerHistoricoPedidos();
        }

        function exportarExcel() {
            google.script.run
                .withSuccessHandler(function(url) {
                    window.open(url, '_blank');
                })
                .withFailureHandler(mostrarError)
                .exportarDatosExcel();
        }

        function exportarRango() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                mostrarNotificacion('❌ Por favor selecciona ambas fechas', 'error');
                return;
            }

            google.script.run
                .withSuccessHandler(function(url) {
                    window.open(url, '_blank');
                })
                .withFailureHandler(mostrarError)
                .exportarDatosRango(fechaInicio, fechaFin);
        }

        function mostrarError(error) {
            console.error('Error:', error);
            document.getElementById('contenido').innerHTML = 
                '<div style="color: red; text-align: center;">Error: ' + error + '</div>';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Event listeners
        document.getElementById('searchCodigo').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarPedido();
            }
        });

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Inicializar
        window.onload = function() {
            cargarDatos();
            iniciarAutoUpdate();
        };
    </script>
</body>
</html>
